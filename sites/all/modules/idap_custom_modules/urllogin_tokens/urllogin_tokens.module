<?php
require_once(drupal_get_path('module','urllogin').'/urllogin_security.inc');

/* Implements hook_token_info() */

function urllogin_tokens_token_info() {
	$types['urllogin_tokens'] = array(
		'name' => t('URLLogin Tokens'),
		'description' => t('Create tokens to include in subscriptions emails to enable users to login by clicking tokenised link'),
	);
	
	$urllogin_tokens['urllogin_user_token'] = array(
		'name' => t('URLLogin Token'),
		'description' => t('Token string generated by urllogin module'),
		'type' => 'current-user',
	);
	$urllogin_tokens['urllogin_user_name'] = array(
		'name' => t('URLLogin Token'),
		'description' => t('Username generated by urllogin module'),
	);
	
	return array(
		'types' => $types,
		'tokens' => array('urllogin_tokens' => $urllogin_tokens),
	);
}

function urllogin_tokens_tokens($type, $tokens, array $data = array(), array $options = array()) {
	$account = user_load($GLOBALS['user']->uid);
	
	if ($type == 'urllogin_tokens' && !empty($data['user'])) {
		foreach($tokens as $name=>$original) {
			switch($name) {
				case 'urllogin_user_token':
					$replacements[$original] = _get_urllogin_token($account);
					break;
				case 'urllogin_user_name':
					$replacements[$original] = _get_urllogin_username($account);
					break;
			}
		}
	}
	return $replacements;
}

function _get_urllogin_token($account) {
	$uid = $account->uid;
	$codekey = variable_get('urllogin_codekey', 0);
	$urlstr = urllogin_encode($uid, $codekey, urllogin_passphrase());
	return $urlstr;
}

function _get_urllogin_username($account) {
	return $account->name;
}